<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/dashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <title>Boshqaruv paneli</title>
</head>
<body>
    <div class="container hidden" id="dashboardContainer">
        <div class="sidebar">
            <h2>Menejer</h2>
            <ul>
                <li class="sidebar-list" onclick="order()">Buyurtmalar</li>
                <li class="sidebar-list" onclick="zakaz()">Zakaz olish</li>
                <li class="sidebar-list" onclick="showStats()">Statistika</li>
                <li class="logut-btn" onclick="logout()">
                    <i style="color: red" class="fa-solid fa-arrow-right-from-bracket"></i>
                    Chiqish
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="profile-section">
                <div>
                    <strong>Rol:</strong> <span id="userRole">Menejer</span><br />
                    <strong>Vaqt:</strong> <span id="currentTime">--:--</span><br />
                </div>
            </div>
            <h1 style="text-align: center">Buyurtmalar</h1>
            <div id="ordersGrid" class="orders-grid">
                </div>
        </div>

        <div class="zakaz-container" style="display:none;">
            <div class="order-container">
                <form id="orderForm" class="order-form" onsubmit="submitOrder(); return false;">
                    <h2>Yangi Zakaz</h2>
                    <div class="form-group">
                        <label for="customerType">Mijoz turi:</label>
                        <select id="customerType" required>
                            <option value="">Tanlang</option>
                            <option value="Jismoniy shaxs">Jismoniy shaxs</option>
                            <option value="Yuridik shaxs">Yuridik shaxs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">F.I:</label>
                        <input type="text" id="name" placeholder="Familiya Ism" required />
                    </div>
                    <div class="form-group">
                        <label for="district">Tuman:</label>
                        <input type="text" id="district" placeholder="Masalan: Sergeli" required />
                    </div>
                    <div class="form-group">
                        <label for="serviceType">Xizmat turi:</label>
                        <select id="serviceType" required>
                            <option value="">Tanlang</option>
                            <option value="Uskuna">Uskuna (Hardware)</option>
                            <option value="Dasturiy">Dasturiy ta'minot</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="phone">Telefon raqam:</label>
                        <input type="tel" id="phone" placeholder="+998901234567" required />
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" placeholder="example@mail.com" required />
                    </div>
                    <div class="form-group">
                        <label for="description">Muammo tavsifi:</label>
                        <textarea id="description" placeholder="Muammo haqida yozing..." required></textarea>
                    </div>
                    <div id="error-message"></div>
                    <button id="submitBtn" class="btn">Yuborish</button>
                </form>
            </div>
        </div>

        <div class="stats-container" style="display: none;">
            <h1 style="text-align: center;">KPI & Statistika</h1>
            <div style="max-width: 600px; margin: 0 auto;">
                <canvas id="statusChart"></canvas>
            </div>
            <div id="kpi-summary" style="margin-top: 24px; text-align: center;">
                <p>Jami buyurtmalar: <span id="stat-total"></span></p>
                <p>Bajarilgan (fixed): <span id="stat-fixed"></span></p>
                <p>Tasdiqlangan (confirmed): <span id="stat-confirmed"></span></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Umumiy bloklarni bir marta tanlab olish
        const mainContent = document.querySelector(".main-content");
        const zakazContainer = document.querySelector(".zakaz-container");
        const statsContainer = document.querySelector(".stats-container");

        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("token");
            const role = localStorage.getItem("role") || "User";
            if (token && role === "manager") {
                showDashboard(role);
            } else {
                logout();
            }
        });

        // Vaqtni yangilash funksiyasi
        function updateTime() {
            const now = new Date();
            const options = { hour: "2-digit", minute: "2-digit", hour12: true };
            document.getElementById("currentTime").textContent = now.toLocaleTimeString("en-US", options);
        }
        setInterval(updateTime, 60000); // Har 1 daqiqada yangilash

        // Dashboardni ko'rsatish
        function showDashboard(role) {
            document.getElementById("dashboardContainer").classList.remove("hidden");
            document.getElementById("userRole").textContent = role;
            updateTime();
            fetchOrders(); // Buyurtmalarni yuklash
            mainContent.style.display = "block";
            zakazContainer.style.display = "none";
            statsContainer.style.display = "none";
        }

        // Chiqish funksiyasi
        function logout() {
            localStorage.clear();
            window.location = "login.html";
        }

        // "Zakaz olish" bo'limini ko'rsatish
        function zakaz() {
            mainContent.style.display = "none";
            statsContainer.style.display = "none";
            zakazContainer.style.display = "block";
        }

        // "Buyurtmalar" bo'limini ko'rsatish
        function order() {
            zakazContainer.style.display = "none";
            statsContainer.style.display = "none";
            mainContent.style.display = "block";
            fetchOrders(); // Buyurtmalarni qayta yuklash
        }

        // "Statistika" bo'limini ko'rsatish
        function showStats() {
            mainContent.style.display = "none";
            zakazContainer.style.display = "none";
            statsContainer.style.display = "block";
            fetchStats(); // Statistikani yuklash
        }

        // Buyurtmalarni API'dan olish va kartalarga joylashtirish
        async function fetchOrders() {
            const token = localStorage.getItem("token");
            const ordersGrid = document.getElementById("ordersGrid");
            ordersGrid.innerHTML = '<p style="text-align:center; color:#777;">Buyurtmalar yuklanmoqda...</p>'; // Loading indicator

            try {
                const res = await fetch("http://127.0.0.1:3000/orders", {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || "Buyurtmalarni yuklab bo'lmadi!");
                }
                const orders = await res.json();
                ordersGrid.innerHTML = ""; // Clear loading indicator

                if (orders.length === 0) {
                    ordersGrid.innerHTML = '<p style="text-align:center; color:#777;">Hozircha buyurtmalar yo‘q.</p>';
                    return;
                }

                orders.forEach((order) => {
                    const orderCard = document.createElement("div");
                    orderCard.className = "order-card";

                    // Determine status class for styling
                    let statusClass = '';
                    switch(order.status) {
                        case 'new': statusClass = 'status-new'; break;
                        case 'confirmed': statusClass = 'status-confirmed'; break;
                        case 'fixed': statusClass = 'status-fixed'; break;
                        case 'cancelled': statusClass = 'status-cancelled'; break;
                        default: statusClass = 'status-new'; break;
                    }

                    orderCard.innerHTML = `
                        <div class="order-card-header">
                            <strong>Buyurtma ID: #${order.id}</strong>
                            <span class="status ${statusClass}">${order.status}</span>
                        </div>
                        <div class="order-card-body">
                            <p><strong>Mijoz turi:</strong> ${order.customerType || 'Noma\'lum'}</p>
                            <p><strong>Ism:</strong> ${order.name || 'Noma\'lum'}</p>
                            <p><strong>Tuman:</strong> ${order.district || 'Noma\'lum'}</p>
                            <p><strong>Xizmat turi:</strong> ${order.serviceType || 'Noma\'lum'}</p>
                            <p><strong>Telefon:</strong> ${order.phone || 'Noma\'lum'}</p>
                            <p><strong>Email:</strong> ${order.email || 'Noma\'lum'}</p>
                            <p><strong>Vaqt:</strong> ${order.time || 'Noma\'lum'}</p>
                            <p class="description"><strong>Tavsif:</strong> ${order.description || 'Tavsif yo‘q'}</p>
                        </div>
                        <div class="order-card-footer">
                            ${
                                order.status === "confirmed" || order.status === "fixed" || order.status === "cancelled"
                                ? `<span style="color: ${order.status === 'fixed' ? '#28a745' : (order.status === 'cancelled' ? '#dc3545' : '#007bff')}; font-weight: 600;">${order.status === 'fixed' ? 'Bajarildi' : (order.status === 'cancelled' ? 'Bekor qilindi' : 'Tasdiqlangan')}</span>`
                                : `
                                    <button class="confirm-btn" onclick="confirmOrder(${order.id})">Tasdiqlash</button>
                                    <button class="cancel-btn" onclick="deleteOrder(${order.id})">Oʻchirish</button>
                                `
                            }
                        </div>
                    `;
                    ordersGrid.appendChild(orderCard);
                });
            } catch (err) {
                console.error("Buyurtmalarni yuklashda xatolik:", err);
                ordersGrid.innerHTML = `<p style="text-align:center; color:#dc3545;">Buyurtmalarni yuklab bo‘lmadi: ${err.message}</p>`;
            }
        }

        // Buyurtmani tasdiqlash
        async function confirmOrder(orderId) {
            const token = localStorage.getItem("token");
            if (!token) {
                console.log("Avtorizatsiya qilinmagan! Iltimos, tizimga kiring.");
                // In a real app, you'd show a custom modal here
                return;
            }
            // Replace confirm() with a custom modal in a production environment
            if (!window.confirm("Buyurtmani tasdiqlamoqchimisiz?")) {
                return;
            }
            try {
                const res = await fetch(`http://127.0.0.1:3000/orders/${orderId}/confirm`, {
                    method: "PUT",
                    headers: {
                        Authorization: `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || "Tasdiqlashda xatolik yuz berdi!");
                }
                console.log("Buyurtma tasdiqlandi!");
                fetchOrders(); // Buyurtmalarni yangilash
            } catch (err) {
                console.error("Tasdiqlashda xatolik:", err);
                // In a real app, you'd show a custom error modal here
            }
        }

        // Buyurtmani o'chirish
        async function deleteOrder(orderId) {
            const token = localStorage.getItem("token");
            if (!token) {
                console.log("Avtorizatsiya qilinmagan! Iltimos, tizimga kiring.");
                // In a real app, you'd show a custom modal here
                return;
            }
            // Replace confirm() with a custom modal in a production environment
            if (!window.confirm("Haqiqatan ham bu buyurtmani o‘chirmoqchimisiz?")) {
                return;
            }
            try {
                const res = await fetch(`http://127.0.0.1:3000/manager/orders/${orderId}`, {
                    method: "DELETE",
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });
                const data = await res.json();
                if (res.ok) {
                    console.log("Buyurtma o‘chirildi:", data.message);
                    fetchOrders(); // Buyurtmalarni yangilash
                } else {
                    throw new Error(data.message || "O‘chirishda xatolik yuz berdi!");
                }
            } catch (err) {
                console.error("O‘chirishda xatolik:", err);
                // In a real app, you'd show a custom error modal here
            }
        }

        // Yangi buyurtma yuborish (Zakaz olish bo'limi uchun)
        async function submitOrder() {
            const customerType = document.getElementById("customerType").value;
            const name = document.getElementById("name").value.trim();
            const district = document.getElementById("district").value;
            const serviceType = document.getElementById("serviceType").value;
            const phone = document.getElementById("phone").value.trim();
            const email = document.getElementById("email").value.trim();
            const description = document.getElementById("description").value.trim();
            const errorMessage = document.getElementById("error-message");
            const submitBtn = document.getElementById("submitBtn");
            const form = document.getElementById("orderForm");

            errorMessage.style.display = "none";
            submitBtn.disabled = true;
            submitBtn.textContent = "Yuborilmoqda...";

            if (!customerType || !name || !district || !serviceType || !phone || !email || !description) {
                errorMessage.textContent = "Iltimos, barcha maydonlarni to‘ldiring.";
                errorMessage.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.textContent = "Yuborish";
                return;
            }

            try {
                const response = await fetch("http://127.0.0.1:3000/orders", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        customerType,
                        name,
                        district,
                        serviceType,
                        phone,
                        email,
                        description,
                    }),
                });

                if (response.ok) {
                    console.log("Buyurtma muvaffaqiyatli yuborildi! Login va parol emailga yuborildi.");
                    // Replace alert() with a custom modal in a production environment
                    form.reset();
                } else {
                    const error = await response.json();
                    errorMessage.textContent = error.message || "Buyurtma yuborishda xatolik!";
                    errorMessage.style.display = "block";
                }
            } catch (err) {
                errorMessage.textContent = "Server bilan bog‘lanishda xatolik yuz berdi.";
                errorMessage.style.display = "block";
            }

            submitBtn.disabled = false;
            submitBtn.textContent = "Yuborish";
        }

        // STATISTIKA diagrammasi uchun ma'lumotlarni olish va pie chartni chizish
        async function fetchStats() {
            const token = localStorage.getItem("token");
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            try {
                const response = await fetch("http://127.0.0.1:3000/api/statistics", {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Statistikani yuklab bo'lmadi!");
                }
                const stats = await response.json();

                document.getElementById('stat-total').textContent = stats.totalOrders;
                document.getElementById('stat-fixed').textContent = stats.fixedOrders;
                document.getElementById('stat-confirmed').textContent = stats.confirmedOrders;

                const labels = stats.byStatus.map(row => row.status);
                const data = stats.byStatus.map(row => row.count);

                // Pie chart ranglari
                const backgroundColors = [
                    'rgba(255, 99, 132, 0.8)', // Red for 'new' or 'cancelled'
                    'rgba(54, 162, 235, 0.8)', // Blue for 'confirmed'
                    'rgba(75, 192, 192, 0.8)', // Green for 'fixed'
                    'rgba(255, 206, 86, 0.8)', // Yellow
                    'rgba(153, 102, 255, 0.8)', // Purple
                    'rgba(255, 159, 64, 0.8)'  // Orange
                ];

                // Eski diagramma bo‘lsa, yo‘qotamiz
                if(window.statusChartObj) window.statusChartObj.destroy();

                window.statusChartObj = new Chart(ctx, {
                    type: 'pie', // Changed to pie chart
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Buyurtmalar soni (status bo‘yicha)',
                            data: data,
                            backgroundColor: backgroundColors.slice(0, labels.length), // Apply colors based on number of labels
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top', // Position legend at the top
                                labels: {
                                    font: {
                                        family: 'Inter', // Apply Inter font to legend
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                bodyFont: {
                                    family: 'Inter' // Apply Inter font to tooltips
                                },
                                titleFont: {
                                    family: 'Inter'
                                }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error("Statistikani yuklashda xatolik:", err);
                // In a real app, you'd show a custom error modal here
                if(window.statusChartObj) window.statusChartObj.destroy(); // Destroy chart if error
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Inter";
                ctx.fillStyle = "#dc3545";
                ctx.textAlign = "center";
                ctx.fillText("Statistikani yuklab bo‘lmadi!", ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        }
    </script>
</body>
</html>
